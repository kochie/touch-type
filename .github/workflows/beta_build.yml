name: Beta Build

on:
  push:
    branches:
      - beta
      - develop
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch or ref to build"
        required: true
        default: "beta"
        type: string
      upload_to_stores:
        description: "Upload to App Store Connect / Windows Dev Center"
        required: false
        default: false
        type: boolean

jobs:
  build:
    name: Build and Upload
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [macos-26, ubuntu-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Set beta version
        run: |
          node -e "
            const fs = require('fs');
            const p = require('./package.json');
            const base = p.version.replace(/-beta\.\d+$|-alpha\.\d+$/,'');
            p.version = base + '-beta.' + process.env.RUN_NUM;
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2) + '\n');
            console.log('Set version to', p.version);
          "
        env:
          RUN_NUM: ${{ github.run_number }}

      - uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: false

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: pnpm
          cache-dependency-path: ./pnpm-lock.yaml
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}

      - uses: actions/cache@v4
        name: Setup cache for next.js
        with:
          path: |
            ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Install dependencies
        run: |
          # Keep pnpm store inside workspace so resolved paths stay in project (helps electron-builder on CI)
          echo "store-dir=node_modules/.pnpm-store" >> .npmrc
          pnpm install --ignore-scripts
        env:
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}
          APPLE_API_KEY: private_keys/AuthKey_${{ secrets.api_key_id }}.p8
          APPLE_API_KEY_ID: ${{ secrets.api_key_id }}
          APPLE_API_ISSUER: ${{ secrets.api_key_issuer_id }}

      - name: Rebuild native deps for Electron
        run: pnpm exec electron-builder install-app-deps

      - name: Install Snapcraft
        uses: samuelmeuli/action-snapcraft@v1
        if: startsWith(matrix.os, 'ubuntu')
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.snapcraft_token }}

      - name: Set up Xcode
        if: startsWith(matrix.os, 'macos')
        run: |
          # electron-builder 26.x requires actool 26+ (Xcode 26) for .icon asset catalog compilation
          sudo xcode-select -s /Applications/Xcode_26.2.app
          xcodebuild -runFirstLaunch

      - name: Prepare for app notarization
        if: startsWith(matrix.os, 'macos')
        env:
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.provisioning_profile }}
          PP_PATH: build/mas-touchtyper.provisionprofile
          API_KEY_BASE64: ${{ secrets.api_key }}
          API_KEY_PATH: private_keys/AuthKey_${{ secrets.api_key_id }}.p8
        run: |
          mkdir -p private_keys
          echo -n "$API_KEY_BASE64" | base64 --decode --output $API_KEY_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH

      - name: Build Electron app
        run: pnpm run build
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ startsWith(matrix.os, 'ubuntu') && secrets.snapcraft_token || '' }}
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}

          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.supabase_url }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.supabase_anon_key }}
          NEXT_PUBLIC_ACCOUNT_LINK: https://touch-typer.kochie.io/account

      - name: Build/Release Electron app (beta channel, publish always)
        shell: bash
        run: |
          echo "Building for ${{ matrix.os }}, CHANNEL=beta, publish=always"
          if [[ "${{ matrix.os }}" == macos* ]]; then
            pnpm exec electron-builder --config electron-builder.ts --mac default --mac mas --publish always
          elif [[ "${{ matrix.os }}" == windows* ]]; then
            pnpm exec electron-builder --config electron-builder.ts -w --publish always
          else
            pnpm exec electron-builder --config electron-builder.ts -l --publish always
          fi
        env:
          APPLE_API_KEY: private_keys/AuthKey_${{ secrets.api_key_id }}.p8
          APPLE_API_KEY_ID: ${{ secrets.api_key_id }}
          APPLE_API_ISSUER: ${{ secrets.api_key_issuer_id }}
          MAC_LINK: ${{ secrets.mac_certs }}
          MAC_KEY_PASSWORD: ${{ secrets.mac_certs_password }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUNDLE_VERSION: ${{ github.run_number }}
          CHANNEL: beta
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          SNAPCRAFT_STORE_CREDENTIALS: ${{ startsWith(matrix.os, 'ubuntu') && secrets.snapcraft_token || '' }}
          FONTAWESOME_NPM_AUTH_TOKEN: ${{ secrets.FONTAWESOME_NPM_AUTH_TOKEN }}

      - name: Upload to App Store Connect
        if: startsWith(matrix.os, 'macos') && github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_stores == 'true'
        run: |
          version=$(jq -r .version package.json)
          xcrun altool --validate-app -f dist/mas-universal/Touch\ Typer-$version-universal.pkg --type macos --apiKey ${{ secrets.api_key_id }} --apiIssuer ${{ secrets.api_key_issuer_id }}
          xcrun altool --upload-app -f dist/mas-universal/Touch\ Typer-$version-universal.pkg --type macos --apiKey ${{ secrets.api_key_id }} --apiIssuer ${{ secrets.api_key_issuer_id }}

      - name: Upload to Windows Dev Center
        if: startsWith(matrix.os, 'windows') && github.event_name == 'workflow_dispatch' && github.event.inputs.upload_to_stores == 'true'
        run: |
          $jsonContent = Get-Content -Path "$env:GITHUB_WORKSPACE\package.json" -Raw
          $jsonObject = $jsonContent | ConvertFrom-Json
          $version = $jsonObject.version
          $appx = "./dist/Touch Typer $version.appx"

          Set-PSRepository -Name "PSGallery" -InstallationPolicy Trusted
          Install-Module -Name StoreBroker

          $password = ConvertTo-SecureString $env:APPX_UPLOAD_TOKEN -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential $env:APPX_UPLOAD_USERNAME, $password
          Set-StoreBrokerAuthentication -TenantId $env:APPX_UPLOAD_TENANT_ID -Credential $credential

          New-SubmissionPackage -ConfigPath build\store_broker\SBConfig.json -AppxPath $appx

          Update-ApplicationSubmission -AppId $env:APPX_UPLOAD_APP_ID -SubmissionDataPath "build/submission.json" -PackagePath "build/submission.zip" -Force -ReplacePackages -UpdatePublishModeAndVisibility
        env:
          APPX_UPLOAD_TOKEN: ${{ secrets.windows_dev_center_password }}
          APPX_UPLOAD_USERNAME: ${{ secrets.windows_dev_center_username }}
          APPX_UPLOAD_TENANT_ID: ${{ secrets.windows_dev_center_tenant_id }}
          APPX_UPLOAD_APP_ID: "9NG3CCFL631D"
