# Reusable workflow: reserve the next App Store Connect build number.
# Uses a repository variable APP_STORE_BUILD_NUMBER so the number increments
# globally across all workflows (beta, tag release, etc.).
#
# Setup (optional): In repo Settings → Actions → Variables, add
#   APP_STORE_BUILD_NUMBER = (your last uploaded build number).
# If omitted, the first run will create it with value 1.
#
# Concurrency ensures only one reservation runs at a time to avoid duplicates.

name: Reserve App Store Build Number

on:
  workflow_call:
    outputs:
      build_number:
        value: ${{ jobs.reserve.outputs.build_number }}

concurrency:
  group: app-store-build-number
  cancel-in-progress: false

jobs:
  reserve:
    name: Reserve next build number
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ steps.bump.outputs.build_number }}
    permissions:
      actions: write
    steps:
      - name: Get, increment, and save App Store build number
        id: bump
        run: |
          REPO="${{ github.repository }}"
          VAR_NAME="APP_STORE_BUILD_NUMBER"
          API="https://api.github.com/repos/${REPO}/actions/variables/${VAR_NAME}"

          # Get current value (or create variable if missing)
          RESP=$(curl -s -w "\n%{http_code}" -H "Authorization: token ${{ secrets.GH_TOKEN_FOR_VARIABLES }}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API")
          HTTP_BODY=$(echo "$RESP" | head -n -1)
          HTTP_CODE=$(echo "$RESP" | tail -n 1)

          if [ "$HTTP_CODE" = "404" ]; then
            # Variable doesn't exist yet: create it with value 1
            NEW_NUM=1
            curl -s -X POST -H "Authorization: token ${{ secrets.GH_TOKEN_FOR_VARIABLES }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO}/actions/variables" \
              -d "{\"name\":\"${VAR_NAME}\",\"value\":\"1\"}"
            echo "Created ${VAR_NAME}=1"
          else
            CURRENT=$(echo "$HTTP_BODY" | jq -r '.value')
            NEW_NUM=$((CURRENT + 1))
            curl -s -X PATCH -H "Authorization: token ${{ secrets.GH_TOKEN_FOR_VARIABLES }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API" \
              -d "{\"value\":\"${NEW_NUM}\"}"
            echo "Updated ${VAR_NAME}: ${CURRENT} -> ${NEW_NUM}"
          fi

          echo "build_number=${NEW_NUM}" >> "$GITHUB_OUTPUT"
          echo "Using App Store build number: ${NEW_NUM}"
