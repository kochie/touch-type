# Reusable workflow: reserve the next App Store Connect build number.
# Uses a repository variable APP_STORE_BUILD_NUMBER so the number increments
# globally across all workflows (beta, tag release, etc.).
#
# Required: Add a PAT as a repository secret:
#   Name: REPO_VARIABLES_PAT
#   Value: A Personal Access Token with permission to read/write repository variables.
#
#   Classic PAT: scope "repo" (or "public_repo" for public repos).
#   Fine-grained PAT: Repository permissions → Administration → Read and write.
#
# Optional: In Settings → Actions → Variables, add APP_STORE_BUILD_NUMBER = (last
# uploaded build number). If omitted, the first run creates it with value 1.
#
# Concurrency ensures only one reservation runs at a time to avoid duplicates.

name: Reserve App Store Build Number

on:
  workflow_call:
    outputs:
      build_number:
        value: ${{ jobs.reserve.outputs.build_number }}

concurrency:
  group: app-store-build-number
  cancel-in-progress: false

jobs:
  reserve:
    name: Reserve next build number
    runs-on: ubuntu-latest
    outputs:
      build_number: ${{ steps.bump.outputs.build_number }}
    steps:
      - name: Get, increment, and save App Store build number
        id: bump
        env:
          REPO: ${{ github.repository }}
          VAR_NAME: APP_STORE_BUILD_NUMBER
        run: |
          set -e
          API_VAR="https://api.github.com/repos/${REPO}/actions/variables/${VAR_NAME}"
          API_VARS="https://api.github.com/repos/${REPO}/actions/variables"
          # Use Bearer for both classic and fine-grained PATs
          AUTH_HEADER="Authorization: Bearer ${{ secrets.GH_TOKEN_FOR_VARIABLES }}"

          # Get current value
          RESP=$(curl -s -w "\n%{http_code}" \
            -H "$AUTH_HEADER" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "$API_VAR")
          HTTP_BODY=$(echo "$RESP" | head -n -1)
          HTTP_CODE=$(echo "$RESP" | tail -n 1)

          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "::error::Variables API returned $HTTP_CODE. Check GH_TOKEN_FOR_VARIABLES: valid token and permission to read/write repository variables (e.g. Administration for fine-grained PAT)."
            echo "Response: $HTTP_BODY"
            exit 1
          fi

          if [ "$HTTP_CODE" = "404" ]; then
            NEW_NUM=1
            CREATE_RESP=$(curl -s -w "\n%{http_code}" -X POST \
              -H "$AUTH_HEADER" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API_VARS" \
              -d "{\"name\":\"${VAR_NAME}\",\"value\":\"1\"}")
            CREATE_CODE=$(echo "$CREATE_RESP" | tail -n 1)
            if [ "$CREATE_CODE" != "201" ]; then
              echo "::error::Failed to create variable (HTTP $CREATE_CODE). Response: $(echo "$CREATE_RESP" | head -n -1)"
              exit 1
            fi
            echo "Created ${VAR_NAME}=1"
          else
            if [ "$HTTP_CODE" != "200" ]; then
              echo "::error::Unexpected response $HTTP_CODE: $HTTP_BODY"
              exit 1
            fi
            CURRENT=$(echo "$HTTP_BODY" | jq -r '.value')
            if [ -z "$CURRENT" ] || [ "$CURRENT" = "null" ]; then
              echo "::error::Variable value was empty or null. Body: $HTTP_BODY"
              exit 1
            fi
            NEW_NUM=$((CURRENT + 1))
            PATCH_RESP=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "$AUTH_HEADER" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "$API_VAR" \
              -d "{\"value\":\"${NEW_NUM}\"}")
            PATCH_CODE=$(echo "$PATCH_RESP" | tail -n 1)
            if [ "$PATCH_CODE" != "204" ]; then
              echo "::error::Failed to update variable (HTTP $PATCH_CODE). Response: $(echo "$PATCH_RESP" | head -n -1)"
              exit 1
            fi
            echo "Updated ${VAR_NAME}: ${CURRENT} -> ${NEW_NUM}"
          fi

          echo "build_number=${NEW_NUM}" >> "$GITHUB_OUTPUT"
          echo "Using App Store build number: ${NEW_NUM}"
